<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:FleetManager.ViewModels"
             xmlns:m="clr-namespace:FleetManager.Models"
             x:Class="FleetManager.Views.GestionUtilisateursView"
             x:DataType="vm:GestionUtilisateursViewModel"
             x:Name="Root">

    <Grid ColumnDefinitions="250,*">

        <!-- ========================== -->
        <!-- 1. MENU DE GAUCHE          -->
        <!-- ========================== -->
        <Border Grid.Column="0" Background="#F5F5F5" BorderBrush="#E0E0E0" BorderThickness="0,0,1,0">
            <StackPanel Margin="20" VerticalAlignment="Center">
                
                <!-- Logo / Home -->
                <Button Command="{Binding GoToHome}" Cursor="Hand" Background="Transparent" BorderThickness="0" Margin="0,0,0,30">
                    <Image Source="avares://fleet_manager/static/image_logo/logo_fleet_sans-fond.png" Width="150"/>
                </Button>

                <!-- Tableau de bord -->
                <Button Command="{Binding GoToHome}" Cursor="Hand" Background="Transparent" Margin="0,10">
                    <TextBlock Text="Tableau de bord" FontSize="16" Foreground="#333" FontWeight="Medium"/>
                </Button>

                <!-- Ajouter Utilisateur -->
                <Button Command="{Binding OpenAddFormCommand}" Cursor="Hand" Background="Transparent" Margin="0,10">
                    <TextBlock Text="Ajouter Utilisateur" FontSize="16" Foreground="#1976D2" FontWeight="Bold"/>
                </Button>

                <!-- DÃ©connexion -->
                <Button Command="{Binding Logout}" Cursor="Hand" Background="Transparent" Margin="0,10">
                    <TextBlock Text="DÃ©connexion" FontSize="16" Foreground="#D32F2F"/>
                </Button>
            </StackPanel>
        </Border>

        <!-- ========================== -->
        <!-- 2. LISTE DES UTILISATEURS  -->
        <!-- ========================== -->
        <Border Grid.Column="1" Background="#FAFAFA">
            <Grid Margin="30" RowDefinitions="Auto,*">

                <TextBlock Grid.Row="0" Text="Gestion des Utilisateurs" FontSize="26" FontWeight="Bold" Margin="0,0,0,20" Foreground="#263238"/>

                <!-- Tableau -->
                <DataGrid Grid.Row="1" ItemsSource="{Binding Users}" AutoGenerateColumns="False" IsReadOnly="True" 
                          GridLinesVisibility="Horizontal" BorderThickness="1" BorderBrush="#EEE" HeadersVisibility="Column">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Nom" Binding="{Binding Nom}" Width="*"/>
                        <DataGridTextColumn Header="PrÃ©nom" Binding="{Binding Prenom}" Width="*"/>
                        <DataGridTextColumn Header="Email" Binding="{Binding Email}" Width="1.5*"/>
                        
                        <!-- Role via RoleInfo -->
                        <DataGridTextColumn Header="RÃ´le" Binding="{Binding RoleInfo.Nom_role}" Width="*"/>
                        
                        <DataGridTemplateColumn Header="Actions" Width="140">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal" Spacing="15" HorizontalAlignment="Center">
                                        
                                        <!-- Modifier -->
                                        <Button ToolTip.Tip="Modifier" 
                                                Command="{Binding #Root.((vm:GestionUtilisateursViewModel)DataContext).OpenEditFormCommand}" 
                                                CommandParameter="{Binding}" 
                                                Background="Transparent" Cursor="Hand">
                                            <TextBlock Text="âœï¸" FontSize="16"/>
                                        </Button>
                                        
                                        <!-- Supprimer (SuperAdmin seulement) -->
                                        <Button ToolTip.Tip="Supprimer" 
                                                IsVisible="{Binding #Root.((vm:GestionUtilisateursViewModel)DataContext).IsSuperAdmin}"
                                                Command="{Binding #Root.((vm:GestionUtilisateursViewModel)DataContext).AskDeleteCommand}" 
                                                CommandParameter="{Binding}" 
                                                Background="Transparent" Foreground="Red" Cursor="Hand">
                                            <TextBlock Text="ðŸ—‘" FontSize="16"/>
                                        </Button>

                                    </StackPanel>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </Border>

        <!-- ========================================== -->
        <!-- 3. POPUP : FORMULAIRE AJOUT/MODIF          -->
        <!-- ========================================== -->
        <Border Background="#99000000" IsVisible="{Binding IsFormOpen}" Grid.Column="0" Grid.ColumnSpan="2" ZIndex="2000">
            <Grid>
                <Border Background="White" CornerRadius="12" Padding="30" Width="450" HorizontalAlignment="Center" VerticalAlignment="Center" BoxShadow="0 10 25 0 #66000000">
                    <StackPanel Spacing="15">
                        <TextBlock Text="Fiche Utilisateur" FontSize="22" FontWeight="Bold" Foreground="#333" HorizontalAlignment="Center" Margin="0,0,0,10"/>

                        <StackPanel Spacing="5">
                            <TextBlock Text="Informations" FontWeight="Bold" FontSize="12" Foreground="Gray"/>
                            <TextBox Text="{Binding Nom}" Watermark="Nom"/>
                            <TextBox Text="{Binding Prenom}" Watermark="PrÃ©nom"/>
                            <TextBox Text="{Binding Email}" Watermark="Email"/>
                        </StackPanel>

                        <!-- Section RÃ´le : ActivÃ©e que pour SuperAdmin -->
                        <StackPanel Spacing="5">
                            <TextBlock Text="RÃ´le" FontWeight="Bold" FontSize="12" Foreground="Gray"/>
                            <ComboBox ItemsSource="{Binding Roles}" 
                                      SelectedItem="{Binding SelectedRole}" 
                                      IsEnabled="{Binding IsSuperAdmin}"
                                      HorizontalAlignment="Stretch">
                                <ComboBox.ItemTemplate>
                                    <DataTemplate><TextBlock Text="{Binding Nom_role}"/></DataTemplate>
                                </ComboBox.ItemTemplate>
                            </ComboBox>
                            <TextBlock Text="* Seul le SuperAdmin peut changer le rÃ´le" FontSize="10" Foreground="Gray" IsVisible="{Binding !IsSuperAdmin}"/>
                        </StackPanel>

                        <!-- Section MDP : Visible que pour SuperAdmin (ou ajout) -->
                        <StackPanel Spacing="5" IsVisible="{Binding ShowPasswordField}">
                            <TextBlock Text="RÃ©initialiser le mot de passe (Optionnel)" 
                                       FontWeight="Bold" FontSize="12" Foreground="Gray"/>
                            <TextBox Text="{Binding Password}" 
                                     Watermark="Nouveau mot de passe" 
                                     PasswordChar="â€¢"/>
                        </StackPanel>

                        <TextBlock Text="{Binding Error}" Foreground="#D32F2F" TextWrapping="Wrap" FontSize="12"/>

                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Spacing="15" Margin="0,10,0,0">
                            <Button Content="Annuler" Command="{Binding CloseFormCommand}" Cursor="Hand" Background="Transparent" Foreground="#666"/>
                            <Button Content="Enregistrer" Command="{Binding SubmitFormCommand}" Cursor="Hand" Background="#1976D2" Foreground="White" CornerRadius="4" Padding="20,8"/>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </Grid>
        </Border>

        <!-- ========================================== -->
        <!-- 4. POPUP : CONFIRMATION SUPPRESSION        -->
        <!-- ========================================== -->
        <Border Background="#99000000" IsVisible="{Binding IsDeleteDialogOpen}" Grid.Column="0" Grid.ColumnSpan="2" ZIndex="3000">
            <Grid>
                <Border Background="White" CornerRadius="12" Padding="25" Width="350" HorizontalAlignment="Center" VerticalAlignment="Center" BoxShadow="0 5 15 0 #66000000">
                    <StackPanel Spacing="20">
                        <TextBlock Text="Suppression" FontSize="20" FontWeight="Bold" Foreground="#C62828" HorizontalAlignment="Center"/>
                        
                        <TextBlock Text="Voulez-vous vraiment supprimer cet utilisateur dÃ©finitivement ?" 
                                   TextWrapping="Wrap" TextAlignment="Center" Foreground="#555" FontSize="14"/>

                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="20">
                            <Button Content="Annuler" Command="{Binding CancelDeleteCommand}" Cursor="Hand" Background="Transparent" Foreground="#333"/>
                            <Button Content="Supprimer" Command="{Binding ConfirmDeleteCommand}" Cursor="Hand" Background="#C62828" Foreground="White" CornerRadius="4" Padding="15,8"/>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </Grid>
        </Border>

    </Grid>
</UserControl>