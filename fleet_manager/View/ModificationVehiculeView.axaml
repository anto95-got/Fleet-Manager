<UserControl xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:vm="clr-namespace:FleetManager.ViewModels"
    xmlns:m="clr-namespace:FleetManager.Models"
    x:Class="FleetManager.Views.ModificationVehiculeView"
    x:DataType="vm:ModificationVehiculeViewModel"
    x:Name="Root">

    <Grid ColumnDefinitions="250,*">

        <!-- ========================================== -->
        <!-- 1. MENU DE GAUCHE                          -->
        <!-- ========================================== -->
        <Border Grid.Column="0" Background="#FFB3B3B3">
            <StackPanel Margin="20" VerticalAlignment="Center">
                
                <Button Command="{Binding GoToHome}" Cursor="Hand" Background="Transparent" BorderThickness="0" Margin="0,0,0,20">
                    <Image Source="avares://fleet_manager/static/image_logo/logo_fleet_sans-fond.png" Width="150" Height="150"/>
                </Button>

                <Button Command="{Binding GoToHome}" Cursor="Hand" Background="Transparent" Margin="0,10">
                    <Button.Styles>
                        <Style Selector="Button:pointerover /template/ ContentPresenter">
                            <Setter Property="Background" Value="LightGray"/> 
                        </Style>
                    </Button.Styles>
                    <TextBlock Text="Tableau de bord" FontSize="16"/>
                </Button>

                <Button Command="{Binding OpenAddFormCommand}" Cursor="Hand" Background="Transparent" Margin="0,10">
                    <Button.Styles>
                        <Style Selector="Button:pointerover /template/ ContentPresenter">
                            <Setter Property="Background" Value="LightGray"/>
                        </Style>
                    </Button.Styles>
                    <TextBlock Text="Ajouter un véhicule" FontSize="16"/>
                </Button>

                <Button Command="{Binding Logout}" Cursor="Hand" Background="Transparent" Margin="0,10">
                    <Button.Styles>
                        <Style Selector="Button:pointerover /template/ ContentPresenter">
                            <Setter Property="Background" Value="#FF6666"/>
                        </Style>
                    </Button.Styles>
                    <TextBlock Text="Déconnexion" FontSize="16"/>
                </Button>
            </StackPanel>
        </Border>

        <!-- ========================================== -->
        <!-- 2. LISTE DES VÉHICULES                     -->
        <!-- ========================================== -->
        <Border Grid.Column="1" Background="White">
            <Grid Margin="30" RowDefinitions="Auto,*">

                <TextBlock Grid.Row="0" Text="Mes Véhicules" FontSize="24" FontWeight="Bold" Margin="0,0,0,20"/>

                <ScrollViewer Grid.Row="1">
                    <ItemsControl ItemsSource="{Binding MesVehicules}">
                        
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel Orientation="Horizontal" />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>

                        <ItemsControl.ItemTemplate>
                            <!-- x:CompileBindings="False" : Obligatoire ici pour la souplesse du menu -->
                            <DataTemplate x:DataType="m:Vehicule">
                                <Border Background="#F9F9F9" BorderBrush="#DDDDDD" BorderThickness="1"
                                        CornerRadius="8" Width="220" Height="200" Margin="0,0,20,20" Padding="10">

                                    <Grid>
                                        <!-- Infos Véhicule -->
                                        <StackPanel VerticalAlignment="Center" Spacing="5">
                                            <Image Source="avares://fleet_manager/static/image/car_image.png" 
                                                   Width="60" Height="60" Margin="0,15,0,0"/>

                                            <TextBlock FontSize="16" FontWeight="Bold" TextAlignment="Center" TextWrapping="Wrap" Foreground="#111111">
                                                <Run Text="{Binding Marque}"/> <Run Text=" "/> <Run Text="{Binding Modele}"/>
                                            </TextBlock>

                                            <Separator Background="#EEE" Margin="0,5"/>

                                            <StackPanel Orientation="Horizontal" Spacing="5" HorizontalAlignment="Center">
                                                <TextBlock Text="Plaque:" Foreground="Gray" FontSize="12"/>
                                                <TextBlock Text="{Binding Imatricule}" FontWeight="SemiBold" Foreground="#111111" FontSize="12"/>
                                            </StackPanel>

                                            <StackPanel Orientation="Horizontal" Spacing="5" HorizontalAlignment="Center">
                                                <TextBlock Text="Km:" Foreground="Gray" FontSize="12"/>
                                                <TextBlock Text="{Binding Kilometrage}" Foreground="#111111" FontSize="12"/>
                                            </StackPanel>
                                        </StackPanel>

                                        <!-- BOUTON MENU (L'image Editer) -->
                                        <!-- 1. Cursor="Hand" pour la main -->
                                        <!-- 2. Tag="{Binding #Root.DataContext}" pour capturer le ViewModel -->
                                        <!-- BOUTON MENU (L'image Editer) -->
                                        <!-- BOUTON MENU (L'image Editer) -->
                                    <Button Background="Transparent"
                                            Cursor="Hand"
                                            Width="30" Height="30"
                                            HorizontalAlignment="Right" VerticalAlignment="Top">

                                        <Image Source="avares://fleet_manager/static/image/editer.png"/>

                                        <Button.Flyout>
                                            <Flyout Placement="LeftEdgeAlignedBottom">
                                                <!-- ON DÉSACTIVE LES COMPILED BINDINGS ICI -->
                                                <StackPanel x:CompileBindings="False" Spacing="10" Width="60" Orientation="Horizontal">

                                                    <!-- SUPPRIMER -->
                                                    <Button Background="#FF4444" Height="40" Width="40" CornerRadius="8"
                                                            ToolTip.Tip="Supprimer"
                                                            Cursor="Hand"
                                                            Command="{Binding #Root.((vm:ModificationVehiculeViewModel)DataContext).AskDeleteCommand}"
                                                            CommandParameter="{Binding}">
                                                        <Image Source="avares://fleet_manager/static/image/poubelle-de-recyclage.png"
                                                               Width="25" Height="25"/>
                                                    </Button>

                                                    <!-- MODIFIER -->
                                                    <Button Background="LightGray" Height="40" Width="40" CornerRadius="8"
                                                            ToolTip.Tip="Modifier"
                                                            Cursor="Hand"
                                                            Command="{Binding #Root.((vm:ModificationVehiculeViewModel)DataContext).OpenEditFormCommand}"
                                                            CommandParameter="{Binding}">
                                                        <Image Source="avares://fleet_manager/static/image/sites-internet.png"
                                                               Width="25" Height="25"/>
                                                    </Button>

                                                    <!-- SUIVI -->
                                                    <Button Background="LightGray" Height="40" Width="40" CornerRadius="8"
                                                            ToolTip.Tip="Suivi"
                                                            Cursor="Hand"
                                                            Command="{Binding #Root.((vm:ModificationVehiculeViewModel)DataContext).OpenSuiviCommand}"
                                                            CommandParameter="{Binding}">
                                                        <Image Source="avares://fleet_manager/static/image/suivi.png"
                                                               Width="25" Height="25"/>
                                                    </Button>

                                                </StackPanel>
                                            </Flyout>
                                        </Button.Flyout>

                                    </Button>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Grid>
        </Border>

        <!-- ========================================== -->
        <!-- 3. POPUP : FORMULAIRE                      -->
        <!-- ========================================== -->
        <Border Background="#99000000" IsVisible="{Binding IsFormOpen}" Grid.Column="0" Grid.ColumnSpan="2" ZIndex="2000">
            <Grid HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                <Border Background="White" CornerRadius="8" Padding="20" Width="400" HorizontalAlignment="Center" VerticalAlignment="Center">
                    <StackPanel Spacing="15">
                        <TextBlock Text="Gestion Véhicule" FontSize="18" FontWeight="Bold" Foreground="Black" HorizontalAlignment="Center"/>

                        <TextBox Text="{Binding Imatricule}" Watermark="Immatricule" />
                        <TextBox Text="{Binding Marque}" Watermark="Marque" />
                        <TextBox Text="{Binding Modele}" Watermark="Modèle" />
                        <TextBox Text="{Binding Annee}" Watermark="Année" />
                        <TextBox Text="{Binding Kilometrage}" Watermark="Kilométrage" />

                        <TextBlock Text="{Binding Error}" Foreground="Red" TextWrapping="Wrap" FontSize="12"/>

                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Spacing="10">
                            <Button Content="Annuler" Command="{Binding CloseFormCommand}" Cursor="Hand" Foreground="Black"/>
                            <Button Content="Enregistrer" Command="{Binding SubmitFormCommand}" Cursor="Hand" Background="#4CAF50" Foreground="White"/>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </Grid>
        </Border>

        <!-- ========================================== -->
        <!-- 4. POPUP : CONFIRMATION                    -->
        <!-- ========================================== -->
        <Border Background="#99000000" IsVisible="{Binding IsDeleteDialogOpen}" Grid.Column="0" Grid.ColumnSpan="2" ZIndex="3000">
            <Grid HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                <Border Background="White" CornerRadius="8" Padding="20" Width="300" HorizontalAlignment="Center" VerticalAlignment="Center">
                    <StackPanel Spacing="15">
                        <TextBlock Text="ATTENTION" FontSize="18" FontWeight="Bold" Foreground="Red" HorizontalAlignment="Center"/>
                        
                        <TextBlock Text="Êtes-vous sûr de vouloir supprimer ce véhicule ?" 
                                   TextWrapping="Wrap" TextAlignment="Center" Foreground="Black"/>

                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="15">
                            <Button Content="Annuler" Command="{Binding CancelDeleteCommand}" Cursor="Hand" Foreground="Black"/>
                            <Button Content="Supprimer" Command="{Binding ConfirmDeleteCommand}" Cursor="Hand" Background="Red" Foreground="White"/>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </Grid>
        </Border>

    </Grid>
</UserControl>