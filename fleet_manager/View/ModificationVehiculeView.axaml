<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:FleetManager.ViewModels"
             xmlns:m="clr-namespace:FleetManager.Models"
             x:Class="FleetManager.Views.ModificationVehiculeView"
             x:DataType="vm:ModificationVehiculeViewModel"
             x:Name="Root">

    <UserControl.Resources>
        <vm:StatusToColorConverter x:Key="StatusToColorConverter"/>
        <vm:KiloFormatConverter x:Key="KiloFormatConverter"/>
    </UserControl.Resources>
    
    <UserControl.Styles>
        <!-- Animation fluide -->
        <Style Selector="Button">
            <Setter Property="RenderTransform" Value="none" />
            <Setter Property="Transitions">
                <Transitions>
                    <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.2" />
                </Transitions>
            </Setter>
        </Style>

        <!-- Action au survol : Zoom -->
        <Style Selector="Button:pointerover">
            <Setter Property="RenderTransform" Value="scale(1.05)" />
            <Setter Property="ZIndex" Value="10" />
            <Setter Property="Cursor" Value="Hand" />
        </Style>

        <!-- Action au survol : Garder la couleur d'origine ! -->
        <Style Selector="Button:pointerover /template/ ContentPresenter#PART_ContentPresenter">
            <Setter Property="Background" Value="{TemplateBinding Background}" />
            <!-- Optionnel : change la couleur du texte si besoin, sinon garde par défaut -->
            <Setter Property="Foreground" Value="{TemplateBinding Foreground}" />
            <Setter Property="Opacity" Value="0.9"/>
        </Style>
    </UserControl.Styles>

    <Grid ColumnDefinitions="250,*">

        <!-- ========================== -->
        <!-- 1. MENU DE GAUCHE (Gris clair) -->
        <!-- ========================== -->
        <Border Grid.Column="0" Background="#F5F5F5" BorderBrush="#E0E0E0" BorderThickness="0,0,1,0">
            <StackPanel Margin="20" VerticalAlignment="Center">
                <Button Command="{Binding GoToHome}" Cursor="Hand" Background="Transparent" BorderThickness="0" Margin="0,0,0,30">
                    <Image Source="avares://fleet_manager/static/image_logo/logo_fleet_sans-fond.png" Width="150" Height="150"/>
                </Button>

                <Button Command="{Binding GoToHome}" Cursor="Hand" Background="Transparent" Margin="0,10">
                    <TextBlock Text="Tableau de bord" FontSize="16" Foreground="#333" FontWeight="Medium"/>
                </Button>

                <Button Command="{Binding OpenAddFormCommand}" Cursor="Hand" Background="Transparent" Margin="0,10">
                    <TextBlock Text="Ajouter un véhicule" FontSize="16" Foreground="#1976D2" FontWeight="Bold"/>
                </Button>

                <Button Command="{Binding Logout}" Cursor="Hand" Background="Transparent" Margin="0,10">
                    <TextBlock Text="Déconnexion" FontSize="16" Foreground="#D32F2F"/>
                </Button>
            </StackPanel>
        </Border>

        <!-- ========================== -->
        <!-- 2. LISTE DES VÉHICULES     -->
        <!-- ========================== -->
        <Border Grid.Column="1" Background="#FAFAFA">
            <Grid Margin="30" RowDefinitions="Auto,*">

                <TextBlock Grid.Row="0" Text="Parc Automobile" FontSize="26" FontWeight="Bold" Margin="0,0,0,20" Foreground="#263238"/>

                <ScrollViewer Grid.Row="1">
                    <ItemsControl ItemsSource="{Binding MesVehicules}">
                        
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel Orientation="Horizontal" />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>

                        <ItemsControl.ItemTemplate>
                            <!-- x:CompileBindings="False" OBLIGATOIRE ici -->
                            <DataTemplate x:DataType="m:Vehicule">
                                <Border Background="White" BorderBrush="#E0E0E0" BorderThickness="1"
                                        CornerRadius="10" Width="240" Height="260" Margin="0,0,20,20" Padding="15"
                                        BoxShadow="0 2 8 0 #E0E0E0">

                                    <Grid>
                                        <StackPanel VerticalAlignment="Top" Spacing="8">
                                            
                                            <!-- Image -->
                                            <Image Source="avares://fleet_manager/static/image/car_image.png" 
                                                   Width="80" Height="60" Margin="0,5,0,0"/>

                                            <!-- Badge Statut -->
                                            <Border Background="{Binding Status, Converter={StaticResource StatusToColorConverter}}"
                                                    CornerRadius="12" Padding="10,4" HorizontalAlignment="Center">
                                                <TextBlock Text="{Binding Status}" 
                                                           Foreground="White" 
                                                           FontSize="10" 
                                                           FontWeight="Bold" 
                                                           />
                                            </Border>

                                            <!-- Marque & Modèle -->
                                            <TextBlock FontSize="18" FontWeight="Bold" TextAlignment="Center" TextWrapping="Wrap" Foreground="#333">
                                                <Run Text="{Binding Marque}"/> <Run Text="{Binding Modele}"/>
                                            </TextBlock>

                                            <Separator Background="#F0F0F0" Height="1" Margin="10,5"/>

                                            <!-- Plaque -->
                                            <StackPanel Orientation="Horizontal" Spacing="5" HorizontalAlignment="Center">
                                                <TextBlock Text="Plaque:" Foreground="#999" FontSize="12"/>
                                                <TextBlock Text="{Binding Imatricule}" FontWeight="SemiBold" Foreground="#333" FontSize="12"/>
                                            </StackPanel>

                                            <!-- Km -->
                                            <StackPanel Orientation="Horizontal" Spacing="5" HorizontalAlignment="Center">
                                                <TextBlock Text="Km:" Foreground="#999" FontSize="12"/>
                                                <TextBlock Text="{Binding Kilometrage, Converter={StaticResource KiloFormatConverter}}" 
                                                           FontWeight="SemiBold" Foreground="#333" FontSize="12"/>
                                            </StackPanel>
                                            
                                            <!-- Capacité -->
                                            <StackPanel Orientation="Horizontal" Spacing="5" HorizontalAlignment="Center">
                                                <TextBlock Text="Réservoir:" Foreground="#999" FontSize="12"/>
                                                <TextBlock Text="{Binding Capacite}" FontWeight="SemiBold" Foreground="#333" FontSize="12"/>
                                                <TextBlock Text="L" Foreground="#333" FontSize="12"/>
                                            </StackPanel>
                                            
                                            
                                        </StackPanel>

                                        <!-- BOUTON MENU (EDITER) -->
                                        <Button Background="Transparent" Cursor="Hand" Width="30" Height="30"
                                                HorizontalAlignment="Right" VerticalAlignment="Top">

                                            <Image Source="avares://fleet_manager/static/image/editer.png"/>

                                            <Button.Flyout>
                                                <Flyout Placement="BottomEdgeAlignedRight">
                                                    <StackPanel x:CompileBindings="False" Spacing="10" Width="140">
                                                        
                                                        <!-- SUIVI : MODIFIÉ POUR OUVRIR LA POPUP -->
                                                        <Button Background="#E3F2FD" CornerRadius="5" ToolTip.Tip="Voir l'historique"
                                                                Cursor="Hand" HorizontalAlignment="Stretch"
                                                                Command="{Binding #Root.((vm:ModificationVehiculeViewModel)DataContext).OpenSuiviListCommand}"
                                                                CommandParameter="{Binding}">
                                                            <StackPanel Orientation="Horizontal" Spacing="10">
                                                                <Image Source="avares://fleet_manager/static/image/suivi.png" Width="20"/>
                                                                <TextBlock Text="Suivi" VerticalAlignment="Center" Foreground="#1976D2"/>
                                                            </StackPanel>
                                                        </Button>

                                                        <!-- MODIFIER -->
                                                        <Button Background="#F5F5F5" CornerRadius="5" ToolTip.Tip="Modifier"
                                                                Cursor="Hand" HorizontalAlignment="Stretch"
                                                                Command="{Binding #Root.((vm:ModificationVehiculeViewModel)DataContext).OpenEditFormCommand}"
                                                                CommandParameter="{Binding}">
                                                            <StackPanel Orientation="Horizontal" Spacing="10">
                                                                <Image Source="avares://fleet_manager/static/image/sites-internet.png" Width="20"/>
                                                                <TextBlock Text="Modifier" VerticalAlignment="Center" Foreground="#333"/>
                                                            </StackPanel>
                                                        </Button>

                                                        <!-- SUPPRIMER -->
                                                        <Button Background="#FFEBEE" CornerRadius="5" ToolTip.Tip="Supprimer"
                                                                Cursor="Hand" HorizontalAlignment="Stretch"
                                                                Command="{Binding #Root.((vm:ModificationVehiculeViewModel)DataContext).AskDeleteCommand}"
                                                                CommandParameter="{Binding}">
                                                            <StackPanel Orientation="Horizontal" Spacing="10">
                                                                <Image Source="avares://fleet_manager/static/image/poubelle-de-recyclage.png" Width="20"/>
                                                                <TextBlock Text="Supprimer" VerticalAlignment="Center" Foreground="#D32F2F"/>
                                                            </StackPanel>
                                                        </Button>

                                                    </StackPanel>
                                                </Flyout>
                                            </Button.Flyout>

                                        </Button>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Grid>
        </Border>

        <!-- ========================================== -->
        <!-- 3. POPUP : FORMULAIRE AJOUT/MODIF          -->
        <!-- ========================================== -->
        <Border Background="#99000000" IsVisible="{Binding IsFormOpen}" Grid.Column="0" Grid.ColumnSpan="2" ZIndex="2000">
            <Grid>
                <Border Background="White" CornerRadius="12" Padding="30" Width="450" HorizontalAlignment="Center" VerticalAlignment="Center" BoxShadow="0 10 25 0 #66000000">
                    <StackPanel Spacing="15">
                        <TextBlock Text="Fiche Véhicule" FontSize="22" FontWeight="Bold" Foreground="#333" HorizontalAlignment="Center" Margin="0,0,0,10"/>

                        <StackPanel Spacing="5">
                            <TextBlock Text="Immatriculation" Foreground="#666" FontSize="12"/>
                            <TextBox Text="{Binding Imatricule}" Watermark="Ex: AA-123-BB" Foreground="#333"/>
                        </StackPanel>

                        <Grid ColumnDefinitions="*, 10, *">
                            <StackPanel Grid.Column="0" Spacing="5">
                                <TextBlock Text="Marque" Foreground="#666" FontSize="12"/>
                                <TextBox Text="{Binding Marque}" Watermark="Ex: Renault" Foreground="#333"/>
                            </StackPanel>
                            <StackPanel Grid.Column="2" Spacing="5">
                                <TextBlock Text="Modèle" Foreground="#666" FontSize="12"/>
                                <TextBox Text="{Binding Modele}" Watermark="Ex: Clio" Foreground="#333"/>
                            </StackPanel>
                        </Grid>

                        <Grid ColumnDefinitions="*, 10, *">
                            <StackPanel Grid.Column="0" Spacing="5">
                                <TextBlock Text="Année" Foreground="#666" FontSize="12"/>
                                <TextBox Text="{Binding Annee}" Watermark="Ex: 2020" Foreground="#333"/>
                            </StackPanel>
                            <StackPanel Grid.Column="2" Spacing="5">
                                <TextBlock Text="Capacité Réservoir (L)" Foreground="#666" FontSize="12"/>
                                <TextBox Text="{Binding Capacite}" Watermark="Ex: 50" Foreground="#333"/>
                            </StackPanel>
                        </Grid>

                        <StackPanel Spacing="5">
                            <TextBlock Text="Kilométrage Actuel" Foreground="#666" FontSize="12"/>
                            <TextBox Text="{Binding Kilometrage}" Watermark="Ex: 120000" Foreground="#333"/>
                        </StackPanel>
                        
                        <StackPanel Spacing="5">
                            <TextBlock Text="Prix d'achat" Foreground="#666" FontSize="12">
                                <TextBox Text="{Binding PrixVehicule}" Watermark="Ex:10000 " Foreground="#333"></TextBox>
                            </TextBlock>
                        </StackPanel>

                        <TextBlock Text="{Binding Error}" Foreground="#D32F2F" TextWrapping="Wrap" FontSize="12"/>

                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Spacing="15" Margin="0,10,0,0">
                            <Button Content="Annuler" Command="{Binding CloseFormCommand}" Cursor="Hand" Background="Transparent" Foreground="#666"/>
                            <Button Content="Enregistrer" Command="{Binding SubmitFormCommand}" Cursor="Hand" Background="#1976D2" Foreground="White" CornerRadius="4" Padding="20,8"/>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </Grid>
        </Border>

        <!-- ========================================== -->
        <!-- 4. POPUP : CONFIRMATION SUPPRESSION        -->
        <!-- ========================================== -->
        <Border Background="#99000000" IsVisible="{Binding IsDeleteDialogOpen}" Grid.Column="0" Grid.ColumnSpan="2" ZIndex="3000">
            <Grid>
                <Border Background="White" CornerRadius="12" Padding="25" Width="350" HorizontalAlignment="Center" VerticalAlignment="Center" BoxShadow="0 5 15 0 #66000000">
                    <StackPanel Spacing="20">
                        <TextBlock Text="Suppression" FontSize="20" FontWeight="Bold" Foreground="#C62828" HorizontalAlignment="Center"/>
                        
                        <TextBlock Text="Voulez-vous vraiment supprimer ce véhicule définitivement ?" 
                                   TextWrapping="Wrap" TextAlignment="Center" Foreground="#555" FontSize="14"/>

                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="20">
                            <Button Content="Annuler" Command="{Binding CancelDeleteCommand}" Cursor="Hand" Background="Transparent" Foreground="#333"/>
                            <Button Content="Supprimer" Command="{Binding ConfirmDeleteCommand}" Cursor="Hand" Background="#C62828" Foreground="White" CornerRadius="4" Padding="15,8"/>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </Grid>
        </Border>

        <!-- ========================================== -->
        <!-- 5. POPUP : LISTE DES SUIVIS (AJOUT)        -->
        <!-- ========================================== -->
        <Border Background="#99000000" IsVisible="{Binding IsSuiviListOpen}" Grid.Column="0" Grid.ColumnSpan="2" ZIndex="2500">
            <Grid>
                <Border Background="White" CornerRadius="12" Padding="20" Width="600" Height="500" HorizontalAlignment="Center" VerticalAlignment="Center" BoxShadow="0 4 10 0 #55000000">
                    <Grid RowDefinitions="Auto, *, Auto">
                        <StackPanel Grid.Row="0" Margin="0,0,0,15">
                            <TextBlock Text="Historique des Trajets" FontSize="20" FontWeight="Bold" Foreground="#333"/>
                            <TextBlock Text="Cliquez sur un suivi pour le modifier" FontSize="12" Foreground="Gray"/>
                        </StackPanel>

                        <ScrollViewer Grid.Row="1">
                            <ItemsControl ItemsSource="{Binding ListeSuivisDuVehicule}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <!-- Clic = Navigation vers la page d'édition détaillée -->
                                        <Button Command="{Binding #Root.((vm:ModificationVehiculeViewModel)DataContext).GoToHistoriqueDetailCommand}"
                                                CommandParameter="{Binding}"
                                                Background="Transparent" BorderThickness="0" Padding="0" Margin="0,0,0,10" HorizontalAlignment="Stretch" Cursor="Hand">
                                            <Border Background="#F9F9F9" BorderBrush="#DDD" BorderThickness="1" CornerRadius="5" Padding="15">
                                                <Grid ColumnDefinitions="Auto, *, Auto">
                                                    <TextBlock Text="{Binding DateSuivi, StringFormat='{}{0:dd/MM/yyyy}'}" FontWeight="Bold" Width="100" VerticalAlignment="Center" Foreground="Black"/>
                                                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                        <TextBlock Text="{Binding Destination}" FontWeight="SemiBold" Foreground="#1565C0"/>
                                                        <TextBlock Text="{Binding Status, StringFormat='Ouvert: {0}'}" FontSize="11" Foreground="red"/>
                                                    </StackPanel>
                                                    <TextBlock Grid.Column="2" Text="Modifier >" Foreground="#1976D2" FontWeight="Bold" VerticalAlignment="Center"/>
                                                </Grid>
                                            </Border>
                                        </Button>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                        
                        <TextBlock Grid.Row="1" Text="Aucun historique." IsVisible="{Binding !ListeSuivisDuVehicule.Count}" HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="Black"/>

                        <Button Grid.Row="2" Content="Fermer" Command="{Binding CloseSuiviListCommand}" HorizontalAlignment="Right" Margin="0,15,0,0" Background="Black" Cursor="Hand" Foreground="White"/>
                    </Grid>
                </Border>
            </Grid>
        </Border>

    </Grid>
</UserControl>