<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:FleetManager.ViewModels"
             xmlns:m="clr-namespace:FleetManager.Models"
             x:Class="FleetManager.Views.SuivieView"
             x:DataType="vm:SuivieViewModel"
             x:Name="Root">

    <UserControl.Resources>
        <vm:SuiviStatusColorConverter x:Key="StatusColorConverter"/>
        <vm:SuiviStatusTextConverter x:Key="StatusTextConverter"/>
        <vm:KiloFormatConverter x:Key="KiloFormatConverter"/>
    </UserControl.Resources>

    <!-- ðŸ”¥ STYLES AJOUTÃ‰S POUR LA VISIBILITÃ‰ ET L'INTERACTION -->
    <UserControl.Styles>
        <Style Selector="Button">
            <Setter Property="RenderTransform" Value="none" />
            <Setter Property="Transitions">
                <Transitions>
                    <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.1" />
                </Transitions>
            </Setter>
        </Style>
        <Style Selector="Button:pointerover">
             <!-- Petit zoom au survol -->
            <Setter Property="RenderTransform" Value="scale(1.02)" />
            <Setter Property="Cursor" Value="Hand" />
        </Style>
        <!-- EmpÃªche le bouton de devenir invisible au survol -->
        <Style Selector="Button:pointerover /template/ ContentPresenter#PART_ContentPresenter">
            <Setter Property="Background" Value="{TemplateBinding Background}" />
            <Setter Property="Opacity" Value="0.95" />
        </Style>
        
        <!-- Style pour les TextBox (LisibilitÃ©) -->
        <Style Selector="TextBox">
            <Setter Property="Background" Value="White"/>
            <Setter Property="Foreground" Value="Black"/>
            <Setter Property="BorderBrush" Value="#CCC"/>
        </Style>
    </UserControl.Styles>

    <Grid ColumnDefinitions="250,*">

        <!-- MENU GAUCHE -->
        <Border Grid.Column="0" Background="#F5F5F5" BorderBrush="#E0E0E0" BorderThickness="0,0,1,0">
            <StackPanel Margin="20" VerticalAlignment="Center">
                <Button Command="{Binding GoToHome}" Cursor="Hand" Background="Transparent" BorderThickness="0" Margin="0,0,0,20">
                    <Image Source="avares://fleet_manager/static/image_logo/logo_fleet_sans-fond.png" Width="150" Height="150"/>
                </Button>
                <Button Command="{Binding GoToHome}" Cursor="Hand" Background="Transparent" Margin="0,10">
                    <TextBlock Text="Tableau de bord" FontSize="16" Foreground="#333"/>
                </Button>
                <Button Command="{Binding OpenAddFormCommand}" Cursor="Hand" Background="Transparent" Margin="0,10">
                    <TextBlock Text="Ajouter un Suivi" FontSize="16" FontWeight="Bold" Foreground="#1976D2"/>
                </Button>
            </StackPanel>
        </Border>

        <!-- CONTENU PRINCIPAL -->
        <Border Grid.Column="1" Background="#FAFAFA">
            <Grid Margin="30" RowDefinitions="Auto,*">
                <TextBlock Grid.Row="0" Text="Suivi des Trajets" FontSize="24" FontWeight="Bold" Margin="0,0,0,20" Foreground="#263238"/>

                <ScrollViewer Grid.Row="1">
                    <ItemsControl ItemsSource="{Binding MesSuivis}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate><StackPanel Spacing="10" /></ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>

                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:CompileBindings="False">
                                
                                <!-- ðŸ”¥ LE BOUTON CONTENEUR QUI DECLENCHE LA NAVIGATION -->
                                <Button Command="{Binding #Root.((vm:SuivieViewModel)DataContext).GoToDetailCommand}"
                                        CommandParameter="{Binding}"
                                        Background="Transparent" 
                                        Padding="0" 
                                        HorizontalAlignment="Stretch" 
                                        HorizontalContentAlignment="Stretch"
                                        BorderThickness="0">

                                    <Border Background="White" BorderBrush="#E0E0E0" BorderThickness="1" CornerRadius="8" Padding="15" BoxShadow="0 2 5 0 #EEE">
                                        
                                        <Grid ColumnDefinitions="80, *, 150, 160">
                                            
                                            <!-- COL 0 : Image + Statut -->
                                            <StackPanel Grid.Column="0" VerticalAlignment="Center" Spacing="5">
                                                <Image Source="avares://fleet_manager/static/image/car_image.png" Width="50" Height="50"/>
                                                <Border Background="{Binding Status, Converter={StaticResource StatusColorConverter}}"
                                                        CornerRadius="10" Padding="5,2" HorizontalAlignment="Center">
                                                    <TextBlock Text="{Binding Status, Converter={StaticResource StatusTextConverter}}"
                                                               Foreground="White" FontSize="9" FontWeight="Bold"/>
                                                </Border>
                                            </StackPanel>

                                            <!-- COL 1 : Infos VÃ©hicule -->
                                            <StackPanel Grid.Column="1" VerticalAlignment="Center" Margin="15,0">
                                                <TextBlock FontSize="18" FontWeight="Bold" Foreground="#333">
                                                    <Run Text="{Binding Vehicule.Marque}"/> <Run Text="{Binding Vehicule.Modele}"/>
                                                </TextBlock>
                                                
                                                <TextBlock Text="{Binding Vehicule.Imatricule}" FontSize="14" FontWeight="SemiBold" Foreground="#666" Margin="0,2,0,5"/>
                                                
                                                <StackPanel Orientation="Vertical" Spacing="2">
                                                    <TextBlock Foreground="#444">
                                                        <Run Text="DÃ©part: " FontWeight="Bold"/> 
                                                        <Run Text="{Binding KmDepart, Converter={StaticResource KiloFormatConverter}}"/> <Run Text=" km"/>
                                                    </TextBlock>
                                                    <TextBlock Foreground="#444" IsVisible="{Binding !Status}">
                                                        <Run Text="Retour: " FontWeight="Bold"/> 
                                                        <Run Text="{Binding KmArrivee, Converter={StaticResource KiloFormatConverter}}"/> <Run Text=" km"/>
                                                    </TextBlock>
                                                </StackPanel>
                                            </StackPanel>

                                            <!-- COL 2 : Destination -->
                                            <StackPanel Grid.Column="2" VerticalAlignment="Center">
                                                <TextBlock Text="{Binding Destination}" FontWeight="Bold" TextWrapping="Wrap" Foreground="#1565C0"/>
                                                <TextBlock Text="{Binding DateSuivi, StringFormat='{}{0:dd/MM/yyyy}'}" Foreground="#999" FontSize="12"/>
                                            </StackPanel>

                                            <!-- COL 3 : ACTIONS (Boutons internes) -->
                                            <StackPanel Grid.Column="3" VerticalAlignment="Center" Spacing="5">
                                                
                                                <!-- A. SI EN COURS -->
                                                <StackPanel IsVisible="{Binding Status}" Spacing="5">
                                                    <Button Command="{Binding #Root.((vm:SuivieViewModel)DataContext).OpenClotureFormCommand}"
                                                            CommandParameter="{Binding}"
                                                            Background="#4CAF50" Foreground="White"
                                                            HorizontalAlignment="Stretch" HorizontalContentAlignment="Center" CornerRadius="4">
                                                        <TextBlock Text="Terminer" FontSize="12" FontWeight="Bold"/>
                                                    </Button>
                                                </StackPanel>

                                                <!-- B. SI TERMINÃ‰ -->
                                                <StackPanel IsVisible="{Binding !Status}" Spacing="2">
                                                    <ItemsControl ItemsSource="{Binding Pleins}">
                                                        <ItemsControl.ItemTemplate>
                                                            <DataTemplate>
                                                                <TextBlock Foreground="#333" FontSize="11" HorizontalAlignment="Center" Margin="0,2,0,0">
                                                                    <Run Text="+ " FontWeight="Bold" Foreground="#1565C0"/>
                                                                    <Run Text="{Binding Litres}"/>
                                                                    <Run Text=" L"/>
                                                                </TextBlock>
                                                            </DataTemplate>
                                                        </ItemsControl.ItemTemplate>
                                                    </ItemsControl>
                                                </StackPanel>

                                                <!-- SUPPRIMER -->
                                                <Button Command="{Binding #Root.((vm:SuivieViewModel)DataContext).AskDeleteCommand}"
                                                        CommandParameter="{Binding}"
                                                        Background="#FFEBEE" Foreground="#D32F2F"
                                                        HorizontalAlignment="Stretch" HorizontalContentAlignment="Center" Margin="0,5,0,0" CornerRadius="4">
                                                    <TextBlock Text="Supprimer" FontSize="12" FontWeight="Bold"/>
                                                </Button>

                                            </StackPanel>
                                        </Grid>
                                    </Border>
                                </Button>
                                
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Grid>
        </Border>

        <!-- POPUP 1 : CRÃ‰ATION -->
        <Border Background="#99000000" IsVisible="{Binding IsFormOpen}" Grid.Column="0" Grid.ColumnSpan="2" ZIndex="2000">
            <Grid HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                <Border Background="White" CornerRadius="8" Padding="20" Width="400" HorizontalAlignment="Center" VerticalAlignment="Center" BoxShadow="0 10 25 0 #66000000">
                    <StackPanel Spacing="15">
                        <TextBlock Text="Nouveau Trajet" FontSize="18" FontWeight="Bold" HorizontalAlignment="Center" Foreground="#333"/>
                        <TextBlock Text="VÃ©hicule :" FontWeight="Bold" Foreground="#555"/>
                        <ComboBox ItemsSource="{Binding ListeVehicules}" SelectedItem="{Binding SelectedVehiculeForAdd}" HorizontalAlignment="Stretch">
                            <ComboBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Foreground="Black"><Run Text="{Binding Marque}"/> <Run Text="{Binding Modele}"/> (<Run Text="{Binding Imatricule}"/>)</TextBlock>
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>
                        <TextBox Text="{Binding NewDestination}" Watermark="Destination"/>
                        <TextBox Text="{Binding NewKmDepart}" Watermark="Km DÃ©part"/>
                        <DatePicker SelectedDate="{Binding NewDate}" HorizontalAlignment="Stretch"/>
                        <TextBlock Text="{Binding Error}" Foreground="#D32F2F" FontSize="12"/>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Spacing="10">
                            <Button Content="Annuler" Command="{Binding CloseFormCommand}" Cursor="Hand" Background="Transparent" Foreground="#666"/>
                            <Button Content="CrÃ©er" Command="{Binding SubmitFormCommand}" Background="#4CAF50" Foreground="White" Cursor="Hand"/>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </Grid>
        </Border>
        
        <!-- POPUP 2 : CLÃ”TURE -->
        <Border Background="#99000000" IsVisible="{Binding IsCloseFormOpen}" Grid.Column="0" Grid.ColumnSpan="2" ZIndex="2000">
            <Grid HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                <Border Background="White" CornerRadius="8" Padding="20" Width="400" HorizontalAlignment="Center" VerticalAlignment="Center" BoxShadow="0 10 25 0 #66000000">
                    <StackPanel Spacing="15">
                        <TextBlock Text="Terminer le Trajet" FontSize="18" FontWeight="Bold" HorizontalAlignment="Center" Foreground="#4CAF50"/>

                        <TextBlock Text="KilomÃ©trage au retour :" FontWeight="Bold" Foreground="#333"/>
                        <TextBox Text="{Binding CloseKmArrivee}" Watermark="Ex: 130500"/>
                        
                        <Separator Background="#EEE"/>
                        <TextBlock Text="Carburant ajoutÃ© (Litres) :" FontWeight="Bold" Foreground="#333"/>
                        <TextBox Text="{Binding CloseLitres}" Watermark="Optionnel"/>

                        <TextBlock Text="{Binding Error}" Foreground="#D32F2F" FontSize="12"/>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Spacing="10">
                            <Button Content="Annuler" Command="{Binding CancelClotureCommand}" Cursor="Hand" Background="Transparent" Foreground="#666"/>
                            <Button Content="Valider" Command="{Binding SubmitClotureCommand}" Background="#4CAF50" Foreground="White" Cursor="Hand"/>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </Grid>
        </Border>

        <!-- POPUP 3 : SUPPRESSION -->
        <Border Background="#99000000" IsVisible="{Binding IsDeleteDialogOpen}" Grid.Column="0" Grid.ColumnSpan="2" ZIndex="3000">
            <Grid HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                <Border Background="White" CornerRadius="8" Padding="25" Width="300" HorizontalAlignment="Center" VerticalAlignment="Center" BoxShadow="0 10 25 0 #66000000">
                    <StackPanel Spacing="15">
                        <TextBlock Text="ATTENTION" FontSize="18" FontWeight="Bold" Foreground="#D32F2F" HorizontalAlignment="Center"/>
                        <TextBlock Text="Supprimer cet historique ?" TextAlignment="Center" Foreground="#555"/>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="15">
                            <Button Content="Non" Command="{Binding CancelDeleteCommand}" Cursor="Hand" Background="Transparent" Foreground="#333"/>
                            <Button Content="Oui" Command="{Binding ConfirmDeleteCommand}" Background="#D32F2F" Foreground="White" Cursor="Hand"/>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </Grid>
        </Border>

    </Grid>
</UserControl>